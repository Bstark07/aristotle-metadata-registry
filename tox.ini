[tox]
toxworkdir=/tmp/tox
skipsdist = True
envlist =
    dj{1.11}-{test,manage}-{azure,linux}-db-{postgres,mariadb,sqlite,mssql}-search-{elastic,whoosh}-module_{amr,dse,cir,apd,gql,api}
    dj{1.11}-{linux}-ally-{metadata_item,metadata_action,static}
    docs
    flake8
    ; isort

[testenv]
passenv =
    HOME # required for pipenv
    LC_ALL
    LANG
    ARISTOTLE_DEV_SKIP_MIGRATIONS
    db: DATABASE_URL
    test: SEARCH
    test: VARIANT
    test: DJANGO_VERSION
    test: PYODBC_FILE
    test: TRAVIS
    test: APPVEYOR
    azure: WINDIR

setenv =
    TOXDIR = {envdir}
    manage: aristotlemdr__BASE_DIR = {envdir}
    test: aristotlemdr__BASE_DIR = {envdir}

    ally: ARISTOTLE_DEV_SKIP_MIGRATIONS = 1
    ally: DATABASE_URL=sqlite:////tmp/ally-db.db
    search-elastic: SEARCH=elastic
    search-whoosh: SEARCH=whoosh
    db-sqlite: DB=sqlite
    db-postgres: DB=postgres
    db-mariadb: DB=mariadb

    module_amr: DJANGO_SETTINGS_MODULE = aristotle_mdr.tests.settings.settings
    module_dse: DJANGO_SETTINGS_MODULE = aristotle_dse.tests.settings
    module_cir: DJANGO_SETTINGS_MODULE = comet.tests.settings
    module_apd: DJANGO_SETTINGS_MODULE = aristotle_pdf.tests.settings
    module_gql: DJANGO_SETTINGS_MODULE = aristotle_mdr_graphql.tests.settings
    module_api: DJANGO_SETTINGS_MODULE = aristotle_mdr_api.tests.settings

    module_amr: MODULE_NAME = aristotle_mdr
    module_dse: MODULE_NAME = aristotle_dse
    module_cir: MODULE_NAME = comet
    module_apd: MODULE_NAME = aristotle_pdf
    module_gql: MODULE_NAME = aristotle_mdr_graphql
    module_api: MODULE_NAME = aristotle_mdr_api

    module_amr: MODULE_PATH = {toxinidir}/python/aristotle-metadata-registry
    module_dse: MODULE_PATH = {toxinidir}/python/aristotle-dataset-extensions
    module_cir: MODULE_PATH = {toxinidir}/python/comet-indicator-registry
    module_apd: MODULE_PATH = {toxinidir}/python/aristotle-pdf-downloads
    module_gql: MODULE_PATH = {toxinidir}/python/aristotle-mdr-graphql
    module_api: MODULE_PATH = {toxinidir}/python/aristotle-mdr-api


platform =
    azure: win32
    linux: linux

deps =
    pipenv==11.8.2
    pip>8.1.1
    setuptools>34.0

    # dj1.11:   Django>=1.11,<2.0

    db-postgres: psycopg2
    db-mariadb:  mysqlclient

    search-elastic: elasticsearch>=5.0.0,<6.0.0
    search-elastic: django-haystack-elasticsearch

    ally: wcag-zoo

    azure: pypiwin32
    azure: lxml<4.0.0
    ; we need nightly for mssql support
    ; db-mssql: -egit+https://github.com/kennethreitz/dj-database-url@master#egg=dj-database-url
    db-mssql: pyodbc

    db-mssql-dj1.11:   django_pyodbc_azure>=1.11,<2.0

commands =
    !module_amr: pip install {toxinidir}
    !module_amr: pip install -r {toxinidir}/dev-requirements.txt
    module_amr: pipenv install {env:MODULE_PATH}/Pipfile --dev
    module_amr: pipenv graph
    !module_amr: pip list

    test: coverage run --branch --source={env:MODULE_PATH}/{env:MODULE_NAME} ./manage.py test {env:MODULE_NAME}
    test-module_amr: pipenv run coverage run -a --branch --source=aristotle_mdr ./manage.py test aristotle_mdr.tests.migrations
    manage: pipenv run coverage run --branch --source=aristotle_mdr python ./manage.py {posargs}

    ally-static: pipenv run coverage run --branch --source=aristotle_mdr ./manage.py test aristotle_mdr.tests.accessibility.TestStaticPageAccessibility
    ally-metadata_item: pipenv run coverage run --branch --source=aristotle_mdr ./manage.py test aristotle_mdr.tests.accessibility.TestMetadataItemPageAccessibility
    ally-metadata_action: pipenv run coverage run --branch --source=aristotle_mdr ./manage.py test aristotle_mdr.tests.accessibility.TestMetadataActionPageAccessibility

[testenv:flake8]
deps =
    flake8
commands=
    flake8  --exclude=migrations,tests,example_mdr --ignore=E501,E225,E123,E722,F401,F841,F403,F811,F821 {toxinidir}/python/aristotle_mdr

[testenv:docs]
changedir= docs
commands=
    pipenv install --dev
    pipenv graph
    sphinx-build -nW -b html -d {envtmpdir}/doctrees . {envtmpdir}/html
deps =
    pipenv==11.8.2
    Sphinx==1.6.7
    sphinx-rtd-theme

[testenv:azure]
basepython = %PYTHON_HOME%\python.exe
