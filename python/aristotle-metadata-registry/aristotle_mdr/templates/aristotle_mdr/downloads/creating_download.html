{% extends 'aristotle_mdr/base.html' %}

<!--Adding meta to refresh every 10 seconds-->
{% block extra_head_scripts %}

{% endblock %}

{% block title %} Preparing download{% endblock %}


{% block content %}
<div style="height: 400px;">
    <div id="download-wrapper" class="text-center">
    {% if download_url %}
        <div>Your document is ready to download</div>
        <a download="" id="document-link" target="_blank" href="{{download_url}}">Click to download your document</a>
    {% else %}
        <i class="fa fa-spinner spinning"></i> Please wait while we are preparing your download
    {% endif %}
    </div>
</div>
<script>
    let interval = setInterval(getDownloadStatus, 1000);

        function success(data) {
            let downloadLink = $('<a></a>').text('Click to download your document');
            downloadLink.attr('id', 'document-link')
            let downloadText = $('<div></div>').text('Your document is ready to download');
            downloadLink.attr({
                'download': '',
                'href': data.download_url,
                'target': '_blank'
            });
            $('#download-wrapper').html(downloadText);
            $('#download-wrapper').append(downloadLink);
            init();
        }
        function getDownloadStatus () {
            $.ajax({
              dataType: 'json',
              url: window.location,
              data: {format: 'json'},
              contentType: 'application/json',
              success: success
            }).fail(function (error){
                console.log("failure", error);
            });
        }

        function getDownload() {
            $('a#document-link').click(function (event) {
                let thankYouDownload = $('<div></div>').text('Thank you for downloading the document');
                let goBackButton = $('<button></button>');
                goBackButton.append($('<i></i>').attr("class", "fa fa-arrow-left"));
                goBackButton.append($('<span></span>').text(" Go Back"));
                goBackButton.attr({
                    onclick: 'history.go(-1)',
                    class: 'btn btn-primary pull-left'
                });
                thankYouDownload.append(goBackButton);
                $('#download-wrapper').html(thankYouDownload);
            })
        }

        {% if download_url %}
        init();
        {% endif %}

        function init() {
            clearInterval(interval);
            getDownload()
        }
</script>
{% endblock %}
